const path = require('path');
// Load environment variables:
// - Prefer `.env` (common convention)
// - Fallback to `env` (some Windows setups omit dotfiles)
const dotenv = require('dotenv');
const envPathDot = path.resolve(__dirname, '../.env');
const envPathNoDot = path.resolve(__dirname, '../env');
const dotResult = dotenv.config({ path: envPathDot });
if (dotResult.error) {
  const noDotResult = dotenv.config({ path: envPathNoDot });
  if (noDotResult.error) {
    // Keep running; platform env vars (Railway/Render) may still be present.
    console.warn(`âš ï¸  dotenv could not load ${envPathDot} or ${envPathNoDot}:`, noDotResult.error.message);
  }
}

const { GoogleGenerativeAI } = require("@google/generative-ai");
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
/* ============================================================
   1. API KEY KONTROLÃœ
============================================================ */



if (!GEMINI_API_KEY) {
  console.error("âŒ GEMINI_API_KEY environment variable bulunamadÄ±!");
  console.error(`ğŸ“ Kontrol edilen dosyalar: ${envPathDot}, ${envPathNoDot}`);
  throw new Error("âŒ GEMINI_API_KEY environment variable bulunamadÄ±! LÃ¼tfen backend/.env dosyanÄ±zda GEMINI_API_KEY deÄŸiÅŸkenini tanÄ±mlayÄ±n.");
}

// Log API key loaded status (without showing the actual key)
console.log(`âœ… GEMINI_API_KEY yÃ¼klendi (uzunluk: ${GEMINI_API_KEY.length} karakter)`);

const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

/* ============================================================
   2. GENERATION CONFIG
============================================================ */

const generationConfig = {
  temperature: 0.7,
  topP: 0.95,
  topK: 40,
  maxOutputTokens: 8192
};

/* ============================================================
   3. API KEY TEST (SADE & GÃœVENÄ°LÄ°R)
============================================================ */

async function testApiKey() {
  const modelsToTry = [
    { id: "gemini-2.5-flash", names: ["models/gemini-2.5-flash", "gemini-2.5-flash"] }
  ];

  let lastError = null;

  for (const candidate of modelsToTry) {
    for (const modelName of candidate.names) {
      try {
        const model = genAI.getGenerativeModel({ model: modelName });
        const result = await model.generateContent("Hello");
        const text = result?.response?.text?.();

        return {
          valid: Boolean(text),
          availableModels: [candidate.id]
        };
      } catch (error) {
        lastError = error;

        const msg = String(error?.message || "");
        const isModelNotFound = msg.includes("404") || msg.toLowerCase().includes("not found");

        // If the error isn't about model availability, don't continue trying fallbacks
        if (!isModelNotFound) {
          return {
            valid: false,
            availableModels: [],
            error: msg
          };
        }

        // Otherwise, try next model format / next model id
      }
    }
  }

  return {
    valid: false,
    availableModels: [],
    error: lastError?.message || "Model not available"
  };
}


/* ============================================================
   4. RAPOR ÃœRETÄ°MÄ° (TEK VE STABÄ°L MODEL)
============================================================ */

async function generateReport(analysisData) {
  const userPrompt = buildUserPrompt(analysisData);

  const systemInstruction = `
You are Gemini, generating NARRATIVE TEXT ONLY for an Ethical AI Evaluation Report.

CRITICAL: Charts are ALREADY GENERATED by the system. You MUST NOT:
- Mention charts
- Say "Imagine a chart here"
- Create placeholder text for charts
- Describe what charts should show
- Output tables instead of charts

Your ONLY job is to write TEXT NARRATIVE that explains the data.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
AVAILABLE DATA
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1) Unified Expert Answers
- All answers merged from responses + generalquestionanswers
- Each answer includes: questionId, principle, role, selectedOption, score, textAnswer

2) Scores Collection (CANONICAL)
- Used for: Overall Risk, Heatmaps, Top Risk Drivers
- DO NOT recompute or reinterpret numeric scores.

3) Ethical Tensions Collection
- Each tension includes: principlesInConflict, severity, reviewState, relatedQuestionIds, relatedAnswers, evidence

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
OUTPUT FORMAT (MARKDOWN)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Generate markdown text ONLY. Use this structure:

## Executive Summary
- Bullet points (3-5 items)
- Mention overall risk level
- Mention tensions if they exist

## Ethical Principles Score Overview
- Explain the 0â€“4 scale with CORRECT risk interpretation:
  - Score 0 = MINIMAL/NO RISK (well-managed, no concerns)
  - Score 1 = LOW RISK (acceptable with minor concerns)
  - Score 2 = MEDIUM RISK (requires monitoring)
  - Score 3 = HIGH RISK (requires immediate attention)
  - Score 4 = MAX/CRITICAL RISK (requires urgent intervention)
- CRITICAL RULE: Higher numeric score = Higher ethical risk. Lower numeric score = Lower ethical risk.
- State: "Scores are derived from the scores collection and are not generated by Gemini."
- Keep SHORT (2-3 sentences)

## Principle Ã— Evaluator Score Matrix Interpretation
- Brief interpretation paragraph (3-5 sentences):
  - Highlight any extreme values (0 or 4)
  - Note evaluator alignment or disagreement
  - Do NOT over-interpret

## Evidence Coverage Analysis
- 1â€“2 sentences about evidence diversity
- Whether evidence types are sufficient or generic

## Top Risk Drivers Analysis
For each top risk driver:
- If textAnswer exists: Summarize in 1 short sentence
- If no textAnswer: State "No qualitative explanation was provided"
- DO NOT fabricate explanations

## Ethical Tensions Analysis
For each tension:
- Which principles conflict
- Why this tension exists (1â€“2 sentences)
- Current status (e.g., "Proposed â†’ unresolved ethical risk")

## Principle-by-Principle Analysis
For each principle:
- 2â€“4 bullet points max:
  - Key risk signals
  - Related tensions (if any)
  - Missing safeguards (if applicable)
- If no issues: "No major ethical concerns identified based on available data."

## Methodology & Data Sources
- Z-Inspection methodology
- scores collection = only numeric source
- responses + generalquestionanswers = qualitative input
- tensions collection = ethical conflict modeling

## Limitations
- List actual limitations from data:
  - Unresolved tensions
  - Limited evidence types
  - Incomplete expert participation
- DO NOT write "No limitations identified" if limitations exist

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CRITICAL â€” RISK INTERPRETATION RULE (MANDATORY)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ GEMINI SAFETY BOUNDARY - YOU MUST NEVER INTERPRET RAW SCORES âš ï¸

All numeric scores you receive are ALREADY CLASSIFIED.
You MUST use the provided risk classifications, NOT interpret scores yourself.

CORRECT RISK SCALE (for reference only - DO NOT INTERPRET):
- Score 0 = MINIMAL/NO RISK (well-managed, no concerns)
- Score 1 = LOW RISK (acceptable with minor concerns)
- Score 2 = MEDIUM RISK (requires monitoring)
- Score 3 = HIGH RISK (requires immediate attention)
- Score 4 = MAX/CRITICAL RISK (requires urgent intervention)

CRITICAL RULES:
1. You receive scores ALREADY classified (e.g., "HIGH_RISK", "MINIMAL_RISK")
2. NEVER infer risk levels from numeric scores
3. NEVER say "score 0.33 indicates high risk" - use the provided classification
4. If classification contradicts your understanding, use the provided classification

Examples:
- You receive: score=0.33, classification="LOW_RISK" â†’ Say "Low risk concern"
- You receive: score=4.0, classification="MAX_RISK" â†’ Say "Critical risk requiring urgent attention"
- NEVER compute: "0.33 < 1 therefore high risk" - WRONG

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
RULES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

- Write concise, dashboard-style narrative
- Do NOT write long academic essays
- Do NOT leave sections empty if data exists
- Do NOT write "No text answer provided" if textAnswer exists
- Do NOT mention charts (they are already generated)
- Do NOT create placeholders
- Focus on EXPLAINING the data, not visualizing it
- ALWAYS apply the risk interpretation rule above when discussing scores
`;

  const modelNamesToTry = [
    "models/gemini-2.5-flash",
    "gemini-2.5-flash"
  ];

  let lastError = null;

  for (const modelName of modelNamesToTry) {
    try {
      console.log(`ğŸ¤– Gemini (${modelName}) rapor Ã¼retiyor...`);

      const model = genAI.getGenerativeModel({
        model: modelName,
        systemInstruction
      });

      const result = await model.generateContent({
        contents: [{ role: "user", parts: [{ text: userPrompt }] }],
        generationConfig
      });

      const report = result.response.text();

      if (!report) {
        throw new Error("âŒ Gemini boÅŸ yanÄ±t dÃ¶ndÃ¼.");
      }

      console.log(`âœ… Rapor baÅŸarÄ±yla oluÅŸturuldu (${modelName}).`);
      return report;

    } catch (error) {
      console.error(`âŒ Model ${modelName} baÅŸarÄ±sÄ±z:`, error.message);
      lastError = error;
      
      // If it's not a 404 (model not found), don't try other models
      if (!error.message.includes("404") && !error.message.includes("not found")) {
        break;
      }
    }
  }

  // If we get here, all models failed
  console.error("âŒ TÃ¼m Gemini modelleri baÅŸarÄ±sÄ±z oldu.");

  if (lastError) {
    const errorMsg = lastError.message || '';
    const errorMsgLower = errorMsg.toLowerCase();
    
    // Check for API key expired or invalid (400 Bad Request)
    if (errorMsg.includes("400") || errorMsgLower.includes("expired") || errorMsgLower.includes("api_key_invalid") || errorMsgLower.includes("api key expired")) {
      throw new Error("âŒ Gemini API Key sÃ¼resi dolmuÅŸ veya geÃ§ersiz. LÃ¼tfen .env dosyanÄ±zdaki GEMINI_API_KEY deÄŸerini kontrol edin ve yeni bir API key oluÅŸturun.");
    }

    if (errorMsg.includes("403") || errorMsgLower.includes("permission_denied")) {
      throw new Error("âŒ Gemini API Key geÃ§ersiz veya yetkisiz.");
    }

    if (errorMsg.includes("429") || errorMsgLower.includes("resource_exhausted") || errorMsgLower.includes("quota")) {
      throw new Error("âŒ Gemini API quota aÅŸÄ±ldÄ±. LÃ¼tfen daha sonra tekrar deneyin.");
    }

    if (errorMsg.includes("404") || errorMsgLower.includes("not found")) {
      throw new Error("âŒ Gemini modeli bulunamadÄ±. LÃ¼tfen API key'inizi ve model eriÅŸiminizi kontrol edin.");
    }

    throw new Error(`âŒ Rapor oluÅŸturulamadÄ±: ${lastError.message}`);
  }

  throw new Error("âŒ Rapor oluÅŸturulamadÄ±: Bilinmeyen hata.");
}

/* ============================================================
   5. PROMPT BUILDER (Z-INSPECTION VERÄ° ODAKLI)
============================================================ */

function buildUserPrompt(data) {
  const project = data.project || {};
  const scores = data.scores || [];
  const unifiedAnswers = data.unifiedAnswers || [];
  const tensions = data.tensions || [];
  const evaluations = data.evaluations || [];

  let prompt = `# AI ETHICS EVALUATION DATA\n\n`;
  prompt += `Analyze the following data using the Z-Inspection methodology.\n`;
  prompt += `**CRITICAL: ALL expert answers and ALL tensions MUST be fully analyzed and explained in the report.**\n\n`;

  /* PROJECT CONTEXT */
  prompt += `## PROJECT CONTEXT\n`;
  prompt += `**Title:** ${project.title || "Untitled Project"}\n`;
  prompt += `**Description:** ${project.fullDescription || project.shortDescription || "N/A"}\n`;
  prompt += `**Status:** ${project.status || "N/A"}\n`;
  prompt += `**Progress:** ${project.progress || 0}%\n\n`;

  /* SCORES */
  prompt += `## ETHICAL PRINCIPLE SCORES\n`;
  if (scores.length === 0) {
    prompt += `No score data available.\n\n`;
  } else {
    scores.forEach((s, i) => {
      prompt += `### Evaluator ${i + 1}${s.role ? ` (${s.role})` : ""}\n`;
      prompt += `Average Score: ${s.totals?.avg?.toFixed(2) || "N/A"} / 4.0\n`;

      if (s.byPrinciple) {
        Object.entries(s.byPrinciple).forEach(([p, v]) => {
          if (v?.avg !== undefined) {
            prompt += `- ${p}: ${v.avg.toFixed(2)} / 4.0\n`;
          }
        });
      }
      prompt += `\n`;
    });
  }

  /* UNIFIED EXPERT ANSWERS (from both responses and generalquestionanswers) */
  prompt += `## ALL EXPERT ANSWERS (UNIFIED FROM ALL SOURCES)\n`;
  if (unifiedAnswers.length === 0) {
    prompt += `No expert answers available.\n\n`;
  } else {
    prompt += `**Total Answers:** ${unifiedAnswers.length}\n\n`;
    
    // Group by principle for better organization
    const answersByPrinciple = {};
    const answersWithoutPrinciple = [];
    
    unifiedAnswers.forEach((answer) => {
      const principle = answer.principle || 'UNCATEGORIZED';
      if (principle === 'UNCATEGORIZED' || !principle) {
        answersWithoutPrinciple.push(answer);
      } else {
        if (!answersByPrinciple[principle]) {
          answersByPrinciple[principle] = [];
        }
        answersByPrinciple[principle].push(answer);
      }
    });
    
    // Output by principle
    Object.entries(answersByPrinciple).forEach(([principle, answers]) => {
      prompt += `### ${principle}\n`;
      answers.forEach((answer, idx) => {
        prompt += `#### Answer ${idx + 1} (${answer.role || 'unknown role'})\n`;
        prompt += `- **Question ID/Code:** ${answer.questionId || answer.questionCode || 'N/A'}\n`;
        prompt += `- **Questionnaire:** ${answer.questionnaireKey || 'N/A'}\n`;
        if (answer.selectedOption) {
          prompt += `- **Selected Option:** ${answer.selectedOption}\n`;
        }
        if (answer.score !== null && answer.score !== undefined) {
          // CORRECT SCALE: 0=MINIMAL, 4=CRITICAL (Higher score = Higher risk)
          const { getRiskLabel } = require('../utils/riskClassification');
          prompt += `- **Risk Score:** ${answer.score} / 4 (${getRiskLabel(answer.score)})\n`;
        }
        if (answer.textAnswer) {
          prompt += `- **Text Answer:** "${answer.textAnswer}"\n`;
        } else {
          prompt += `- **Text Answer:** No text answer provided\n`;
        }
        if (answer.notes) {
          prompt += `- **Notes:** ${answer.notes}\n`;
        }
        prompt += `- **Source Collection:** ${answer.sourceCollection}\n`;
        prompt += `\n`;
      });
    });
    
    // Output uncategorized answers
    if (answersWithoutPrinciple.length > 0) {
      prompt += `### UNCATEGORIZED ANSWERS\n`;
      answersWithoutPrinciple.forEach((answer, idx) => {
        prompt += `#### Answer ${idx + 1} (${answer.role || 'unknown role'})\n`;
        prompt += `- **Question ID/Code:** ${answer.questionId || answer.questionCode || 'N/A'}\n`;
        if (answer.selectedOption) {
          prompt += `- **Selected Option:** ${answer.selectedOption}\n`;
        }
        if (answer.score !== null && answer.score !== undefined) {
          prompt += `- **Risk Score:** ${answer.score} / 4\n`;
        }
        if (answer.textAnswer) {
          prompt += `- **Text Answer:** "${answer.textAnswer}"\n`;
        }
        prompt += `- **Source Collection:** ${answer.sourceCollection}\n`;
        prompt += `\n`;
      });
    }
  }

  /* TENSIONS (FULL DETAILS) */
  prompt += `## ETHICAL TENSIONS (FULL DETAILS)\n`;
  if (tensions.length === 0) {
    prompt += `No ethical tensions identified.\n\n`;
  } else {
    prompt += `**Total Tensions:** ${tensions.length}\n\n`;
    tensions.forEach((t, i) => {
      prompt += `### Tension ${i + 1}: ${t.principle1 || 'Unknown'} vs ${t.principle2 || 'Unknown'}\n`;
      prompt += `- **Tension ID:** ${t._id || 'N/A'}\n`;
      prompt += `- **Claim Statement:** ${t.claimStatement || 'N/A'}\n`;
      prompt += `- **Description:** ${t.description || 'No additional description'}\n`;
      prompt += `- **Severity:** ${t.severity || 'Not specified'} ${t.severity && (t.severity.toLowerCase().includes('high') || t.severity.toLowerCase().includes('critical')) ? 'âš ï¸ REQUIRES DETAILED ANALYSIS' : ''}\n`;
      prompt += `- **Status/Review State:** ${t.status || 'ongoing'}\n`;
      prompt += `- **Created By:** ${t.createdBy || 'N/A'}\n`;
      prompt += `- **Created At:** ${t.createdAt ? new Date(t.createdAt).toISOString() : 'N/A'}\n\n`;
      
      // Votes
      if (t.votes && t.votes.length > 0) {
        prompt += `- **Votes:**\n`;
        const agreeCount = t.votes.filter(v => v.voteType === 'agree').length;
        const disagreeCount = t.votes.filter(v => v.voteType === 'disagree').length;
        prompt += `  - Agree: ${agreeCount}\n`;
        prompt += `  - Disagree: ${disagreeCount}\n`;
        t.votes.forEach((vote, vidx) => {
          prompt += `  - Vote ${vidx + 1}: ${vote.voteType || 'unknown'} by ${vote.userId || 'unknown user'}\n`;
        });
        prompt += `\n`;
      } else {
        prompt += `- **Votes:** No votes yet\n\n`;
      }
      
      // Comments
      if (t.comments && t.comments.length > 0) {
        prompt += `- **Comments:**\n`;
        t.comments.forEach((comment, cidx) => {
          prompt += `  - Comment ${cidx + 1} by ${comment.authorName || comment.authorId || 'unknown'}: "${comment.text || 'N/A'}" (${comment.date ? new Date(comment.date).toISOString() : 'N/A'})\n`;
        });
        prompt += `\n`;
      }
      
      // Evidence
      if (t.evidences && t.evidences.length > 0) {
        prompt += `- **Evidence (${t.evidences.length} items):**\n`;
        t.evidences.forEach((evidence, eidx) => {
          prompt += `  - Evidence ${eidx + 1}: ${evidence.title || 'Untitled'}\n`;
          if (evidence.description) {
            prompt += `    - Description: ${evidence.description}\n`;
          }
          if (evidence.type) {
            prompt += `    - Type: ${evidence.type}\n`;
          }
          if (evidence.fileName) {
            prompt += `    - File: ${evidence.fileName}\n`;
          }
          if (evidence.uploadedBy) {
            prompt += `    - Uploaded by: ${evidence.uploadedBy}\n`;
          }
          if (evidence.comments && evidence.comments.length > 0) {
            prompt += `    - Evidence Comments: ${evidence.comments.length}\n`;
          }
        });
        prompt += `\n`;
      }
      
      // Impact
      if (t.impact) {
        prompt += `- **Impact:**\n`;
        if (t.impact.areas && t.impact.areas.length > 0) {
          prompt += `  - Areas: ${t.impact.areas.join(', ')}\n`;
        }
        if (t.impact.affectedGroups && t.impact.affectedGroups.length > 0) {
          prompt += `  - Affected Groups: ${t.impact.affectedGroups.join(', ')}\n`;
        }
        if (t.impact.description) {
          prompt += `  - Description: ${t.impact.description}\n`;
        }
        prompt += `\n`;
      }
      
      // Mitigation
      if (t.mitigation) {
        prompt += `- **Mitigation:**\n`;
        if (t.mitigation.proposed) {
          prompt += `  - Proposed: ${t.mitigation.proposed}\n`;
        }
        if (t.mitigation.tradeoff) {
          if (t.mitigation.tradeoff.decision) {
            prompt += `  - Tradeoff Decision: ${t.mitigation.tradeoff.decision}\n`;
          }
          if (t.mitigation.tradeoff.rationale) {
            prompt += `  - Tradeoff Rationale: ${t.mitigation.tradeoff.rationale}\n`;
          }
        }
        if (t.mitigation.action) {
          prompt += `  - Action Status: ${t.mitigation.action.status || 'N/A'}\n`;
          if (t.mitigation.action.ownerName) {
            prompt += `  - Action Owner: ${t.mitigation.action.ownerName}\n`;
          }
          if (t.mitigation.action.dueDate) {
            prompt += `  - Due Date: ${new Date(t.mitigation.action.dueDate).toISOString()}\n`;
          }
        }
        prompt += `\n`;
      }
      
      prompt += `\n`;
    });
  }

  /* RISKS */
  prompt += `## RISKS & EVALUATIONS\n`;
  if (evaluations.length === 0) {
    prompt += `No detailed evaluation data available.\n\n`;
  } else {
    evaluations.forEach((e, i) => {
      prompt += `### Stage ${i + 1}: ${e.stage}\n`;
      if (e.generalRisks?.length) {
        e.generalRisks.forEach((r, j) => {
          prompt += `${j + 1}. ${r.title} (Severity: ${r.severity})\n${r.description}\n\n`;
        });
      } else {
        prompt += `No risks identified.\n\n`;
      }
    });
  }

  /* OUTPUT INSTRUCTIONS */
  prompt += `
---
# REPORT GENERATION INSTRUCTIONS

## MANDATORY REQUIREMENTS (NON-NEGOTIABLE):

1. **ALL Expert Answers MUST Be Referenced:**
   - Every expert textAnswer that exists MUST be quoted, referenced, or analyzed in the report
   - If a textAnswer exists but is not mentioned, the report is INCOMPLETE
   - "No text answer provided" should ONLY appear if the expert truly gave no text answer

2. **ALL Ethical Tensions MUST Be Explained:**
   - Every tension MUST have a detailed explanation of WHY it exists
   - Link each tension to the exact expert answers that triggered it
   - Analyze severity (low/medium/high/critical) with justification
   - Include evidence, votes, and mitigation strategies when available
   - NO tension may appear in the report without explanation

3. **High-Risk Behavior Requirements:**
   - If ANY related tension has severity â‰¥ High, you MUST generate a detailed narrative explanation
   - Strong negative expert statements CANNOT result in empty or neutral narratives
   - The report MUST reflect the severity level - high-risk inputs produce high-risk narratives

4. **Principle-by-Principle Analysis:**
   - For EACH ethical principle with data:
     * Aggregate ALL related answers (from ALL sources)
     * Include risk interpretation
     * Identify concrete concerns
     * Discuss ethical trade-offs
     * Identify missing safeguards
   - Empty principle sections are NOT allowed if data exists for that principle

## REPORT STRUCTURE:
Generate a comprehensive PDF-ready report with the following structure:

1. **Executive Summary**
   - Brief overview of the project
   - Key findings and overall risk assessment
   - Main recommendations

2. **Risk Assessment Matrix**
   - Visual representation of risks by principle
   - Severity levels and impact analysis

3. **Principle-by-Principle Analysis**
   - Detailed analysis for each ethical principle with data
   - Scores, evaluations, and evidence
   - ALL expert answers related to that principle
   - Strengths and weaknesses identified
   - NO empty sections if data exists

4. **Tension Analysis**
   - ALL identified ethical tensions with FULL explanation
   - For each tension: WHY it exists, which answers triggered it, severity analysis
   - Evidence, votes, and mitigation strategies
   - Conflict resolution strategies
   - Consensus building approaches

5. **Actionable Recommendations**
   - Prioritized recommendations
   - Implementation steps
   - Timeline and resource requirements

6. **Conclusion**
   - Summary of key points
   - Next steps
   - Contact information

**IMPORTANT FORMATTING REQUIREMENTS:**
- Use proper Markdown syntax for PDF conversion
- Use # for main title, ## for major sections, ### for subsections
- Use **bold** for emphasis, *italic* for important notes
- Use numbered lists (1., 2., 3.) for sequential items
- Use bullet points (- or *) for non-sequential items
- Use tables for structured data when appropriate
- Ensure all content is professional and suitable for PDF export
- Format dates, numbers, and technical terms clearly
`;

  return prompt;
}

/* ============================================================
   EXPORTS
============================================================ */

module.exports = {
  generateReport,
  testApiKey
};
